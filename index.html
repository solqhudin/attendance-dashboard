<!DOCTYPE html> 
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Attendance Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° CDN Chart.js -->
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f4f9;
      text-align: center;
      padding: 15px;
    }

    .container {
      background: #fff;
      max-width: 950px;
      margin: auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: #333;
    }

    .info-box {
      background: #e3f2fd;
      padding: 10px;
      border-radius: 5px;
      display: inline-block;
      margin: 10px 0;
      font-size: 18px;
      font-weight: bold;
    }

    canvas {
      max-width: 100%;
      background: white;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .pagination {
      margin-top: 20px;
    }

    button {
      padding: 10px 15px;
      margin: 5px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #007bff;
      color: white;
      transition: 0.3s;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    button:hover:not(:disabled) {
      background: #0056b3;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>üìä Dashboard % ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h2>
  <div class="info-box">
    üè´ <strong>‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> <span id="totalMeetings"></span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
  </div>

  <canvas id="attendanceChart"></canvas>

  <div class="pagination">
    <button id="prevPage" onclick="changePage(-1)" disabled>‚¨ÖÔ∏è ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
    <span id="currentPage">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
    <button id="nextPage" onclick="changePage(1)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>
  </div>
</div>

<script>
  const firebaseUrl = "https://meeting-attendance-project-default-rtdb.asia-southeast1.firebasedatabase.app/attendance.json";
  const sheetAPI = "https://script.google.com/macros/s/AKfycbwxD4rAfWVZCDNnZ3LhRwtLaQrnB4iq4OoqdlZIuHXtmcKhfrqR-92e_Ao0ajr4aRm6UA/exec"; // üîπ ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô Web App URL ‡∏Ç‡∏≠‡∏á Google Apps Script

  const requiredMeetings = 5; // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 100%
  const itemsPerPage = 10; // ‚úÖ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤
  let currentPage = 1;
  let allLabels = [];
  let allPercentages = [];
  let attendanceCounts = [];

  // üîπ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÅ‡∏•‡∏∞ Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
  Promise.all([
    fetch(sheetAPI).then(response => response.json()), // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Google Sheets
    fetch(firebaseUrl).then(response => response.json()) // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase
  ])
  .then(([allStudents, attendanceData]) => {
    document.getElementById("totalMeetings").innerText = requiredMeetings;
    processData(attendanceData, allStudents);
  })
  .catch(error => console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", error));

  function processData(attendanceData, allStudents) {
    let attendanceCount = {};

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ "‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°")
    Object.values(attendanceData).forEach(record => {
        let studentId = record.studentId;
        if (!attendanceCount[studentId]) {
            attendanceCount[studentId] = { attended: 0, total: requiredMeetings };
        }
        attendanceCount[studentId].attended++; // ‚úÖ ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á
    });

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏•‡∏¢ (‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ "‡∏Ç‡∏≤‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
    Object.keys(allStudents).forEach(studentId => {
        if (!attendanceCount[studentId]) {
            attendanceCount[studentId] = { attended: 0, total: requiredMeetings };
        }
    });

    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á
    allLabels = [];
    allPercentages = [];
    attendanceCounts = [];

    Object.keys(attendanceCount).forEach(studentId => {
        allLabels.push(`${studentId} (${allStudents[studentId]})`);
        const percent = (attendanceCount[studentId].attended / requiredMeetings) * 100;
        allPercentages.push(percent.toFixed(2));
        attendanceCounts.push(attendanceCount[studentId].attended); // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á
    });

    updateChart();
  }

  function updateChart() {
    let startIndex = (currentPage - 1) * itemsPerPage;
    let endIndex = startIndex + itemsPerPage;

    let pageLabels = allLabels.slice(startIndex, endIndex);
    let pagePercentages = allPercentages.slice(startIndex, endIndex);
    let pageAttendanceCounts = attendanceCounts.slice(startIndex, endIndex);

    const ctx = document.getElementById('attendanceChart').getContext('2d');

    if (window.attendanceChart instanceof Chart) {
      window.attendanceChart.destroy();
    }

    window.attendanceChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: pageLabels,
        datasets: [{
          label: '‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (%)',
          data: pagePercentages,
          backgroundColor: 'rgba(75, 192, 192, 0.6)'
        }, {
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°',
          data: pageAttendanceCounts,
          backgroundColor: 'rgba(255, 99, 132, 0.6)'
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            max: 100
          }
        }
      }
    });

    updatePagination();
  }

  function updatePagination() {
    let totalPages = Math.ceil(allLabels.length / itemsPerPage);
    document.getElementById("currentPage").innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage}`;
    
    document.getElementById("prevPage").disabled = currentPage === 1;
    document.getElementById("nextPage").disabled = currentPage === totalPages;
  }

  function changePage(step) {
    currentPage += step;
    updateChart();
  }
</script>

</body>
</html>
